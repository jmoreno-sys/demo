@model Web.Areas.Identidad.Models.CuentaViewModel

@{
    Layout = "_LayoutLogin";
    ViewData["Title"] = "Login";
}
<section style="height: 90vh !important">
    <div class="container-fluid h-custom">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-8 col-md-6 col-sm-12 image-login justify-content-center text-center">
                <img src="~/images/login.jpg" class="img-fluid d-none d-sm-none d-md-inline" alt="Responsive image">
                <div class="row d-flex justify-content-center align-items-center h-100">
                    <div class="col-12 image-login text-center">
                        <span style="font-size: 1.5rem">
                            Plataforma Integral de Información 360°
                        </span>
                    </div>
                </div>
                <div class="row d-flex justify-content-center h-100 text-center">
                    <div class="col-sm-12 col-12">
                        <img src="~/images/logogaranchecknuevo.png" class="img-fluid d-none d-sm-none d-md-inline" alt="Responsive image" height="230" width="230">
                        <img src="~/images/cabecera.png" class="img-fluid d-inline d-sm-inline d-md-none mt-3 mt-sm-3 mt-md-0" alt="Responsive image" height="60" width="60">
                    </div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 col-sm-8 col-9 animate__animated animate__pulse">
                <form id="formLogin" method="post">
                    @Html.AntiForgeryToken()
                    <div class="d-flex flex-row align-items-center justify-content-center justify-content-lg-start">
                        <p class="lead fw-normal mb-0 me-3 d-none d-sm-none d-md-inline">Autenticación de usuario</p>
                        <spam class="circle mx-1" style="background-color: #28487e">
                        </spam>
                        <spam class="circle mx-1" style="background-color: #697fa5">
                        </spam>
                        <spam class="circle mx-1" style="background-color: #a9b6cb">
                        </spam>
                    </div>

                    <div class="divider d-flex align-items-center my-4">
                        <p class="text-center fw-bold mx-3 mb-0"></p>
                    </div>

                    <!-- Email input -->
                    <div class="form-outline mb-4">
                        <input class="form-control form-control-lg text-uppercase input-stringinteger" maxlength="20" placeholder="Ingresar nombre de usuario" asp-for="@Model.Usuario" required />
                        <label class="form-label" asp-for="@Model.Usuario">Usuario</label>
                    </div>

                    <!-- Password input -->
                    <div class="mb-3">
                        <div class="form-outline input-group-append">
                            <input type="password" asp-for="@Model.Clave" id="iptContrasena" class="form-control form-control-lg" placeholder="Ingresar contraseña" required />
                            <button type="button" id="btnMostrarContrasena" class="btn btn-sm"><span class="far fa-eye-slash iconContrasena"></span></button>
                            <label class="form-label" asp-for="@Model.Clave">Contraseña</label>
                        </div>
                    </div>
                    <div class="text-center mt-4 pt-2">
                        <button type="submit" class="btn btn-primary-custom btn-lg" style="background-color: #28487e; padding-left: 2.5rem; padding-right: 2.5rem;">
                            Login
                        </button>
                    </div>
                    <div class="form-group form-group-sm text-center mb-5">
                        <small><a id="forgot-password" href="#">¿Olvidaste tu contraseña?</a></small>
                        <br />
                    </div>
                </form>
            </div>
        </div>
    </div>

    <partial name="Components/_Waves" />
</section>

<div class="modal fade" id="modalClave" tabindex="-1" role="dialog" aria-labelledby="modalClaveLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-key pr-2"></i>Recuperación de Contraseña</h5>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formClave">
                    <div class="row">
                        <div class="col-12">
                            <label class="col-form-label col-form-label-sm required">Identificación</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text py-0"><i class="fa-solid fa-user"></i></span>
                                </div>
                                <input type="text" class="form-control form-control-sm text-uppercase input-border-radius required" id="identificacionUsuario" maxlength="256" autocomplete="off" required>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="col-form-label col-form-label-sm required">Correo</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text py-0"><i class="fas fa-envelope"></i></span>
                                </div>
                                <input type="email" class="form-control form-control-sm text-uppercase required input-border-radius" id="correoUsuario" maxlength="100" required>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary-custom" data-dismiss="modal"><i class="fa-solid fa-x mr-2"></i>Cancelar</button>
                <button type="submit" form="formClave" id="btnGuardar" class="btn btn-primary-custom"><i class="fa-solid fa-floppy-disk mr-2"></i>Enviar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            Swal.close();
            setTimeout(function () {
                $(".image-login").click();
            }, 100);

            $("#formLogin").on("submit", function (e) {
                e.preventDefault();
                $.post({
                    url: "@Url.Action("Inicio", "Cuenta", new { Area = "Identidad"})",
                    data: $("#formLogin").serialize(),
                    beforeSend: function () {
                        initLoadingSwal();
                    },
                    success: function (result) {
                        window.location.href = result.url;
                    },
                    error: function (error) {
                        Swal.fire("¡Error!", error.responseJSON.detail, "error");
                        console.log(error);
                    }
                });
            });

            $('#formClave').submit(function (e) {
                e.preventDefault();
                let antiForgeryToken = $("input[name=__RequestVerificationToken]").val();
                let identificacion = $("#identificacionUsuario").val().trim();
                let correo = $("#correoUsuario").val().trim();
                
                if (!identificacion || identificacion === "") { Swal.fire("¡Error!", "El campo Identificación es obligatorio", "error"); return false; }
                if (!correo || correo === "") { Swal.fire("¡Error!", "El campo Correo es obligatorio", "error"); return false; }
                
                Swal.fire({
                    title: '¿Está seguro de recuperar las credenciales?',
                    text: 'Se generará una nueva clave y será enviada al correo correspondiente',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'OK',
                    cancelButtonText: 'Cancelar',
                    showLoaderOnConfirm: true,
                    allowOutsideClick: () => !Swal.isLoading(),
                    preConfirm: function () {
                        return $.ajax({
                            url: '@Url.Action("RecuperarCredenciales", "Cuenta")',
                            headers: { 'RequestVerificationToken': antiForgeryToken },
                            method: 'POST',
                            cache: false,
                            data: { 'identificacion': identificacion, 'correo': correo },
                            success: function (res) {
                                Swal.fire('¡Envío Exitoso!', `Las credenciales han sido enviadas a: ${correo}`, "success").then((value) => {
                                    $("#formClave")[0].reset();
                                    $("#modalClave").modal("hide");
                                });
                            },
                            error: function (error) {
                                Swal.fire("¡Error!", error.responseJSON.detail, "error");
                                console.log(error);
                            }
                        });
                    }
                });
            });

            $("#modalClave").on("shown.bs.modal", function () {
                $("#formClave")[0].reset();
            });

            $("#btnMostrarContrasena").click(function () {
                if ($("#iptContrasena").attr('type') === "password") {
                    $("#iptContrasena").attr('type', 'text');
                    $('.iconContrasena').removeClass('far fa-eye-slash').addClass('far fa-eye');
                } else {
                    $("#iptContrasena").attr('type', 'password');
                    $('.iconContrasena').removeClass('far fa-eye').addClass('far fa-eye-slash');
                }
            });

            $("#identificacionUsuario").on('input', function () {
                let identificacion = $("#identificacionUsuario").val();
                identificacion = identificacion.trim();
                $("#identificacionUsuario").val(identificacion);
            });

            $("#forgot-password").on("click", function () {
                $("#modalClave").modal("show");
            });
        });
    </script>
}